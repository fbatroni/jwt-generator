/*eslint no-bitwise: "off"*/
/*eslint no-implicit-coercion: [2, { "allow": ["!!", "~"] } ]*/
"use strict";

/********************************************************************
 * Libraries - Why we need 'em
 ********************************************************************/

const role = require('./role.js');

// TODO: Documentation
module.exports = {
  setRules: (group, rules) => (req, res, next) => {
    for (let header in req.headers) {
      if (~header.toLowerCase().indexOf("jwt-role-")) {
        const jwtGroup = header.toLowerCase().replace("jwt-role-", "");
        if (group.toLowerCase() === jwtGroup.toLowerCase()) {
          const jwtUsersRoles = req.headers[header];
          const jwtRolesForRoute = rules[req.url];
          const jwtDefaultRoles = rules['*'];
          if (!jwtRolesForRoute && role.hasRole(jwtDefaultRoles, jwtUsersRoles)) {
            return next();
          } else if (role.hasRole(jwtRolesForRoute, jwtUsersRoles)) {
            return next();
          }
        }
      }
    }
    return res.status(403).json({ error: "Forbidden" });
  }
};
